<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Battements — version audio (2 sinusoïdes)</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --border:rgba(15,23,42,.14);
      --grid:rgba(15,23,42,.08); --text:#0f172a; --muted:rgba(15,23,42,.65);
      --a:#9aa3b2; --b:#2563eb; --sum:#16a34a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:16px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; justify-content:center;
    }
    .card{
      width:min(920px, 96vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:0 10px 22px rgba(15,23,42,.06);
    }
    h1{ margin:0 0 10px; font-size:16px; }
    .top{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-bottom:10px;
    }
    button{
      border:1px solid var(--border);
      background:#f2f4f8;
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    button:hover{ background:#e9edf6; }
    button.primary{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.10);
    }
    .info{
      color:var(--muted);
      font-size:13px;
      font-variant-numeric: tabular-nums;
    }

    canvas{
      width:100%;
      height:220px;
      display:block;
      border:1px solid var(--border);
      border-radius:10px;
      background:linear-gradient(180deg, rgba(15,23,42,.02), transparent);
    }

    .controls{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .row{
      display:grid;
      grid-template-columns: 170px 1fr 220px;
      gap:10px;
      align-items:center;
    }
    label{ color:var(--muted); font-size:13px; }
    input[type="range"]{ width:100%; }
    .val{
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .legend{
      margin-top:8px;
      display:flex; gap:14px; flex-wrap:wrap;
      color:var(--muted); font-size:13px;
    }
    .swatch{
      display:inline-block; width:12px; height:12px; border-radius:3px;
      margin-right:6px; vertical-align:-2px;
      border:1px solid rgba(15,23,42,.18);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Battements (audio) : deux sinusoïdes f et f+Δf + volumes</h1>

    <div class="top">
      <button class="primary" id="toggle">Démarrer</button>
      <button id="panic">Silence immédiat</button>
      <div class="info" id="info"></div>
    </div>

    <canvas id="scope" aria-label="Oscilloscope"></canvas>

    <div class="legend">
      <span><span class="swatch" style="background:var(--a)"></span>Osc 1 : sin(2π f t)</span>
      <span><span class="swatch" style="background:var(--b)"></span>Osc 2 : sin(2π (f+Δf) t)</span>
      <span><span class="swatch" style="background:var(--sum)"></span>Somme (scope)</span>
    </div>

    <div class="controls">
      <div class="row">
        <label for="f">Fréquence de base f (Hz)</label>
        <input id="f" type="range" min="50" max="800" value="220" step="1" />
        <div class="val" id="fVal"></div>
      </div>

      <div class="row">
        <label for="df">Décalage Δf (Hz)</label>
        <input id="df" type="range" min="0" max="30" value="2.0" step="0.1" />
        <div class="val" id="dfVal"></div>
      </div>

      <div class="row">
        <label for="v1">Volume Osc 1</label>
        <input id="v1" type="range" min="0" max="1" value="0.20" step="0.01" />
        <div class="val" id="v1Val"></div>
      </div>

      <div class="row">
        <label for="v2">Volume Osc 2</label>
        <input id="v2" type="range" min="0" max="1" value="0.20" step="0.01" />
        <div class="val" id="v2Val"></div>
      </div>

      <div class="row">
        <label for="vm">Volume Master</label>
        <input id="vm" type="range" min="0" max="1" value="0.35" step="0.01" />
        <div class="val" id="vmVal"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // UI
  const fEl = document.getElementById('f');
  const dfEl = document.getElementById('df');
  const v1El = document.getElementById('v1');
  const v2El = document.getElementById('v2');
  const vmEl = document.getElementById('vm');

  const fVal  = document.getElementById('fVal');
  const dfVal = document.getElementById('dfVal');
  const v1Val = document.getElementById('v1Val');
  const v2Val = document.getElementById('v2Val');
  const vmVal = document.getElementById('vmVal');

  const toggleBtn = document.getElementById('toggle');
  const panicBtn  = document.getElementById('panic');
  const infoEl    = document.getElementById('info');

  const scope = document.getElementById('scope');
  const COL_SUM = getComputedStyle(document.documentElement).getPropertyValue('--sum').trim();
  const GRID = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();

  // Audio
  let audio = null; // {ctx, o1, o2, g1, g2, master, analyser, data, playing}
  let raf = null;

  function setupHiDPI(canvas){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.round(r.width * dpr);
    canvas.height= Math.round(r.height * dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }
  let sctx = setupHiDPI(scope);
  window.addEventListener('resize', () => { sctx = setupHiDPI(scope); });

  function fmt(n, d=2){
    const x = Math.abs(n) < 1e-12 ? 0 : n;
    return x.toFixed(d);
  }

  function ensureAudioGraph(){
    if (audio) return;

    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    o1.type = 'sine';
    o2.type = 'sine';

    const g1 = ctx.createGain();
    const g2 = ctx.createGain();
    const master = ctx.createGain();

    // analyser pour oscilloscope
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 2048;

    // connexions: o1->g1 -> master -> analyser -> destination
    //            o2->g2 -^
    o1.connect(g1);
    o2.connect(g2);
    g1.connect(master);
    g2.connect(master);
    master.connect(analyser);
    analyser.connect(ctx.destination);

    // niveaux init (éviter un "pop" au démarrage)
    const t = ctx.currentTime;
    g1.gain.setValueAtTime(0, t);
    g2.gain.setValueAtTime(0, t);
    master.gain.setValueAtTime(0, t);

    o1.start();
    o2.start();

    audio = {
      ctx, o1, o2, g1, g2, master, analyser,
      data: new Uint8Array(analyser.fftSize),
      playing: false
    };

    // suspend tant que pas démarré
    ctx.suspend();
  }

  function setSmooth(param, value, timeConst=0.02){
    const ctx = audio.ctx;
    const t = ctx.currentTime;
    // setTargetAtTime = lissage exponentiel
    param.setTargetAtTime(value, t, timeConst);
  }

  function updateParams(){
    const f  = Number(fEl.value);
    const df = Number(dfEl.value);
    const f2 = Math.max(0, f + df);

    const v1 = Number(v1El.value);
    const v2 = Number(v2El.value);
    const vm = Number(vmEl.value);

    fVal.textContent  = `f = ${fmt(f,0)} Hz`;
    dfVal.textContent = `Δf = ${fmt(df,1)} Hz → f₂ = ${fmt(f2,1)} Hz`;
    v1Val.textContent = fmt(v1,2);
    v2Val.textContent = fmt(v2,2);
    vmVal.textContent = fmt(vm,2);

    // affichage "beat"
    const beatHz = Math.abs(df);
    const beatPeriod = beatHz > 1e-9 ? (1/beatHz) : Infinity;
    infoEl.textContent = `Battements: ≈ ${fmt(beatHz,2)} Hz (période ≈ ${beatPeriod===Infinity ? '∞' : fmt(beatPeriod,2)+' s'})`;

    if (!audio) return;

    // fréquences (lissage léger)
    setSmooth(audio.o1.frequency, f, 0.02);
    setSmooth(audio.o2.frequency, f2, 0.02);

    // volumes individuels
    setSmooth(audio.g1.gain, v1, 0.03);
    setSmooth(audio.g2.gain, v2, 0.03);

    // volume master (si "playing", on suit le slider; sinon on reste à 0)
    const targetMaster = audio.playing ? vm : 0;
    setSmooth(audio.master.gain, targetMaster, 0.03);
  }

  function start(){
    ensureAudioGraph();
    audio.playing = true;

    audio.ctx.resume().then(() => {
      // fade in master pour éviter clic
      updateParams();
      toggleBtn.textContent = 'Stop';
    });
    if (!raf) raf = requestAnimationFrame(drawScope);
  }

  function stop(){
    if (!audio) return;
    audio.playing = false;

    // fade out
    setSmooth(audio.master.gain, 0, 0.02);

    // suspend un peu après
    const ctx = audio.ctx;
    const t = ctx.currentTime;
    // petit délai (100ms) avant suspend pour laisser le fade out se faire
    setTimeout(() => { ctx.suspend(); }, 120);

    toggleBtn.textContent = 'Démarrer';
    updateParams();
  }

  function panic(){
    if (!audio) return;
    // silence immédiat (sans lissage)
    const t = audio.ctx.currentTime;
    audio.g1.gain.cancelScheduledValues(t);
    audio.g2.gain.cancelScheduledValues(t);
    audio.master.gain.cancelScheduledValues(t);
    audio.g1.gain.setValueAtTime(0, t);
    audio.g2.gain.setValueAtTime(0, t);
    audio.master.gain.setValueAtTime(0, t);
  }

  function drawScope(){
    raf = requestAnimationFrame(drawScope);
    const w = scope.getBoundingClientRect().width;
    const h = scope.getBoundingClientRect().height;

    sctx.clearRect(0,0,w,h);

    // grille
    sctx.save();
    sctx.strokeStyle = GRID;
    sctx.lineWidth = 1;
    for (let x=0; x<=w; x+=60){ sctx.beginPath(); sctx.moveTo(x,0); sctx.lineTo(x,h); sctx.stroke(); }
    for (let y=0; y<=h; y+=50){ sctx.beginPath(); sctx.moveTo(0,y); sctx.lineTo(w,y); sctx.stroke(); }
    sctx.restore();

    // axe central
    sctx.save();
    sctx.strokeStyle = 'rgba(15,23,42,0.22)';
    sctx.lineWidth = 1.5;
    sctx.beginPath();
    sctx.moveTo(0, h/2); sctx.lineTo(w, h/2);
    sctx.stroke();
    sctx.restore();

    if (!audio || audio.ctx.state !== 'running') {
      // message
      sctx.save();
      sctx.fillStyle = 'rgba(15,23,42,0.55)';
      sctx.font = '13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      sctx.fillText('Audio en pause — cliquez sur “Démarrer”', 12, 22);
      sctx.restore();
      return;
    }

    audio.analyser.getByteTimeDomainData(audio.data);

    // waveform
    sctx.save();
    sctx.strokeStyle = COL_SUM;
    sctx.lineWidth = 2.2;
    sctx.beginPath();

    const N = audio.data.length;
    for (let i=0; i<N; i++){
      const x = (i/(N-1)) * w;
      const v = audio.data[i] / 255;       // 0..1
      const y = (1 - v) * h;               // inversion visuelle
      if (i===0) sctx.moveTo(x,y);
      else sctx.lineTo(x,y);
    }
    sctx.stroke();
    sctx.restore();
  }

  // UI events
  function onAnyInput(){ ensureAudioGraph(); updateParams(); }
  fEl.addEventListener('input', onAnyInput);
  dfEl.addEventListener('input', onAnyInput);
  v1El.addEventListener('input', onAnyInput);
  v2El.addEventListener('input', onAnyInput);
  vmEl.addEventListener('input', onAnyInput);

  toggleBtn.addEventListener('click', () => {
    if (!audio || !audio.playing) start();
    else stop();
  });
  panicBtn.addEventListener('click', panic);

  // init display
  updateParams();
  // scope idle message
  requestAnimationFrame(drawScope);
})();
</script>
</body>
</html>